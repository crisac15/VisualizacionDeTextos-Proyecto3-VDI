---
title: "An√°lisis de emociones en 'Conversaci√≥n con una momia'"
author: "Cristopher Acu√±a - Jerson Prendas"
date: "`30/06/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Librer√≠as necesarias
library(stopwords)
library(tidyverse)
library(ggwordcloud)
library(syuzhet)
library(tm)
library(SnowballC)
library(igraph)
library(ggraph)
library(tokenizers)
library(tidytext)
library(ggplot2)
```

## Introducci√≥n

Este an√°lisis se basa en la metodolog√≠a propuesta por D√©bora Rodrigo-Ruiz (2022), utilizando an√°lisis digital de emociones en textos literarios. Se aplica el an√°lisis al cuento "Conversaci√≥n con una momia" de Edgar Allan Poe, con el fin de explorar el vocabulario emocional, la polaridad narrativa y los recursos afectivos que intervienen en la construcci√≥n del texto.

## Carga y limpieza del texto

```{r}
# Versi√≥n 1: texto limpio para wordcloud y red (SIN puntuaci√≥n)
texto <- readLines("Conversacion con una momia.txt", encoding = "UTF-8")
texto <- tolower(paste(texto, collapse = " "))
texto <- gsub("[[:punct:]]", "", texto)
texto <- gsub("[0-9]", "", texto)

# Versi√≥n 2: texto crudo para an√°lisis narrativo (CON puntuaci√≥n)
texto_narrativo <- readLines("Conversacion con una momia.txt", encoding = "UTF-8")
texto_narrativo <- paste(texto_narrativo, collapse = " ")
```

## Nube de palabras emocionales

```{r}
stop_words <- get_stopwords(language = "es")

datos <- tibble(texto = texto) %>%
  unnest_tokens(palabra, texto) %>%
  anti_join(stop_words, by = c("palabra" = "word")) %>%
  filter(nchar(palabra) > 4) %>%
  count(palabra, name = "frecuencia") %>%
  arrange(desc(frecuencia))

ggplot(datos %>% slice_max(frecuencia, n = 120), aes(
  label = palabra,
  size = frecuencia,
  color = frecuencia
)) +
  geom_text_wordcloud_area(shape = "circle", rm_outside = TRUE) +
  scale_size_area(max_size = 16) +
  scale_color_gradient(low = "#1a9641", high = "#d7191c") +
  theme_minimal() +
  labs(title = "Nube de palabras emocionales (top 120)")

```

> La nube de palabras destaca los t√©rminos m√°s frecuentes del texto, una vez eliminadas las stopwords. Entre los m√°s prominentes se encuentran ‚Äúdoctor‚Äù, ‚Äúmomia‚Äù, ‚Äúconde‚Äù, ‚Äúegipcio‚Äù, ‚Äúusted‚Äù y ‚Äúponnonner‚Äù. El tama√±o de cada palabra refleja su frecuencia de aparici√≥n.

## An√°lisis de Polaridad

```{r}
oraciones <- get_sentences(texto_narrativo)
polaridad <- get_sentiment(oraciones, method = "syuzhet", lang = "spanish")

ggplot(data = data.frame(posicion = seq_along(polaridad), polaridad), 
       aes(x = posicion, y = polaridad)) +
  geom_line(color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  labs(title = "An√°lisis de polaridad narrativa",
       x = "Progresi√≥n del texto", y = "Polaridad emocional") +
  theme_minimal()
```

> La polaridad del texto oscila entre valores positivos y negativos, con una tendencia en general hacia la zona neutral. Sin embargo, hay picos negativos muy marcados en algunas secciones, as√≠ como picos positivos en algunas escenas.

## Conteo de emociones (NRC)

```{r}
nrc <- get_nrc_sentiment(get_sentences(texto))
emociones_sum <- colSums(nrc[, 1:8])
barplot(emociones_sum, las = 2, col = rainbow(8), main = "Conteo de emociones NRC")
```

> Hay mucho lenguaje que genera expectativa o curiosidad, cosas inesperadas, incomodidad emocional y desagrado f√≠sico o moral, as√≠ como confianza. Eso se relaciona con escenas donde experimentan con la momia o suceden cosas fuera de lo normal.

## Ô∏èArco Emocional

```{r}

# 1. Dividir en oraciones
oraciones <- get_sentences(texto_narrativo)

# 2. Obtener emociones NRC en espa√±ol por oraci√≥n
emociones <- get_nrc_sentiment(oraciones, lang = "spanish")

# 3. Calcular polaridad: positivo - negativo
polaridad <- emociones$positive - emociones$negative

# 4. Verificar que haya variaci√≥n emocional
if (length(polaridad) > 2 && any(is.finite(polaridad)) && sd(polaridad) > 0) {
  # Aplicar suavizado con DCT
  arco <- get_dct_transform(polaridad,
                            low_pass_size = min(length(polaridad), 20),
                            scale_range = TRUE)

  # 5. Graficar arco emocional
  plot(arco, type = "l", col = "darkgreen", lwd = 2,
       main = "Arco emocional de 'Conversaci√≥n con una momia'",
       xlab = "Progresi√≥n narrativa", ylab = "Polaridad emocional")
  abline(h = 0, lty = 2, col = "gray")
} else {
  message("No se detect√≥ suficiente polaridad en el texto completo.")
}
```

> Una curva suave que resume c√≥mo var√≠a la emoci√≥n a lo largo del cuento completo. Empieza neutro, baja en la parte de m√°s tensi√≥n (la resurrecci√≥n y el golpe al doctor), y luego sube un poco hacia el final. Esa ca√≠da en el centro del gr√°fico coincide con el momento perturbador de la historia.

## üï∏Ô∏è Red de palabras (coocurrencia)

```{r}
# Leer de nuevo el texto y unir el texto completo
texto <- readLines("Conversacion con una momia.txt", encoding = "UTF-8")
texto <- paste(texto, collapse = " ")

# Dividir en oraciones
oraciones <- unlist(tokenize_sentences(texto))

# Fragmentar en bloques de 5 oraciones
fragmentos <- split(oraciones, ceiling(seq_along(oraciones) / 5))
fragmentos_texto <- sapply(fragmentos, paste, collapse = " ")

# Procesamiento del texto sin stemming para preservar palabras
procesar_texto <- function(texto) {
  corpus <- VCorpus(VectorSource(texto))
  corpus <- tm_map(corpus, content_transformer(tolower))
  corpus <- tm_map(corpus, removePunctuation)
  corpus <- tm_map(corpus, removeNumbers)
  corpus <- tm_map(corpus, removeWords, stopwords("spanish"))
  corpus <- tm_map(corpus, stripWhitespace)
  return(corpus)
}

corpus <- procesar_texto(fragmentos_texto)

# Crear matriz t√©rmino-documento
tdm <- TermDocumentMatrix(corpus, control = list(wordLengths = c(4, Inf)))
mat <- as.matrix(tdm)

# Filtrar palabras frecuentes
frecuencias <- rowSums(mat)
palabras_top <- names(sort(frecuencias, decreasing = TRUE))[1:40]
mat_filtrado <- mat[palabras_top, ]

# Binarizar y crear matriz de coocurrencia
mat_bin <- mat_filtrado
mat_bin[mat_bin >= 1] <- 1
cooc <- mat_bin %*% t(mat_bin)
diag(cooc) <- 0

# NO eliminar relaciones d√©biles: solo eliminar donde TODA la fila es cero
cooc <- cooc[rowSums(cooc) > 0, colSums(cooc) > 0]

# Crear y visualizar grafo
g <- graph.adjacency(cooc, weighted = TRUE, mode = "undirected")
g <- simplify(g)

# Atributos visuales
V(g)$label <- V(g)$name
V(g)$color <- rgb(0.6, 0.9, 1, alpha = 0.8)
V(g)$label.color <- "black"
E(g)$color <- "gray50"
E(g)$width <- E(g)$weight

# Visualizaci√≥n
set.seed(123)
layout <- layout_with_fr(g)
par(mar = c(0, 0, 2, 0))
plot(g,
     layout = layout,
     vertex.size = 8,
     vertex.label.cex = 0.9,
     vertex.label.dist = 0.4,
     main = "Red de palabras por fragmentos (relaciones visibles)")

```

> Un grafo donde cada nodo es una palabra, y las l√≠neas entre ellas indican que esas palabras aparecen juntas en fragmentos de 5 oraciones. Estas conexiones muestran que muchas de las palabras importantes est√°n asociadas entre s√≠ repetidamente.

## Conclusi√≥n

Este an√°lisis permite observar c√≥mo la narrativa de Poe utiliza vocabulario emocional para generar tensi√≥n, iron√≠a y sorpresa. El arco emocional, el conteo NRC y la red sem√°ntica revelan la estructura interna del relato. El enfoque digital empleado se basa en m√©todos similares a los usados por Rodrigo-Ruiz (2022) en la narrativa cervantina. El cuento no es solo gracioso ni solo macabro; se mueve entre asco, sorpresa, burla y algo de tristeza, generando una experiencia emocional, las palabras m√°s usadas y conectadas (como momia, doctor, nariz, conde, egipcio) nos dicen que el texto est√° muy enfocado en el cuerpo humano y la ciencia.
El gr√°fico de polaridad y el arco emocional muestran c√≥mo cambia el tono del cuento varias veces. No es todo miedo ni todo comedia: hay una parte m√°s tensa en el medio, tambi√©n se nota que las emociones m√°s fuertes en el texto son la anticipaci√≥n, el asco y la sorpresa. Esto tiene sentido porque el cuento est√° lleno de cosas inesperadas, descripciones raras y escenas que incomodan. 
Por √∫ltimo, la red de palabras ayuda a ver que los mismos conceptos se repiten y se conectan en distintas partes del cuento. Eso refuerza la idea de que hay una estructura clara, que todo gira alrededor del mismo grupo de temas y esto le da coherencia al texto de Poe.
